---
layout: post
title:  "PySAP - An implementation of SAP in Python"
date:   2025-04-27 9:00:00
---

I thought i would model my own house in SAP to get a deeper understanding the SAP calculations.  
My EPC below - I know not great rating...

![epc](/assets/epc.png)

To summarise what the EPC told me:
```
This is what my EPC told me:
- 4 bedrooms mid terraced house
- Age band: 1930-1949
- Total floor area: 80m2
- Main heating system: Boiler and radiators, mains gas
- Control: Programmer, room thermostat and TRVs
- Floor: Solid, no insulation (assumed)
- Windows: double glazing
- Walls: Solid brick, as built, no insulation (assumed)
- Roof: Pitched roof, no insulation
- Lighting: Low energy lighting in all fixed outlets
- Floor height: 2.50m
- Natural ventilation

Recommendations:
- Internal or external wall insulation: Â£4,000 - Â£14,000|
- Solar water heating: Â£4,000 - Â£6,000
- Solar photovoltaic panels: Â£3,500 - Â£5,500
```

Yes, we don't have loft insulation ðŸ˜” We have so much stuff that we needed the space. I guess the stuff acts somewhat like insulation.
Anyways, the text below shows my implementation using the [SAP 2012 specification](https://bregroup.com/documents/d/bre-group/sap-2012_9-92), I've called it PySAP since it's written in Python. I have created it in a Jupyternotebook so I can write code and see the output in the notebook - SAP is pretty simple compared to other models so this is OK. I converted the notebook to markdown using the command:
```
jupyter nbconvert pysap.ipynb --to markdown
```
I will release the code in the future - for now it's very rough code at the moment and only works in certain cases. The plan is edit until i can model my house fully. It is NOT intendedd to be a full working SAP implementation. I need to do more adjustments before it looks like my house.

```python
import math
```

# 1. Overall dimensions


```python
# Inputs
basement_area = 0
ground_floor_area = 38
first_floor_area = 38
second_floor_area = 0
ground_floor_storey_height = 2.4
first_floor_storey_height = 2.6

# Calculations
TFA = basement_area + ground_floor_area + first_floor_area + second_floor_area
ground_V = ground_floor_area * ground_floor_storey_height
first_V = first_floor_area * first_floor_storey_height
DV =  ground_V + first_V

# Outputs
print(f"Box 4 TFA: {TFA}")
print(f"Box 5 Dwelling volume: {DV}")
```

    Box 4 TFA: 76
    Box 5 Dwelling volume: 190.0


# 2. Ventilation rate


```python
# Chimneys/flues/fans
open_chimneys = 0 * 80  # (6a)
open_flues = 0 * 20  # (6b)
closed_fire = 0 * 10  # (6c)
solid_fuel = 0 * 20  # (6d)
other_heater = 0 * 35  # (6e)
blocked = 0 * 20  # (6f)
fans = 1 * 10  # (7a)
vents = 0 * 10  # (7b)
flueless = 0 * 40  # (7c)

# Calculate infiltration from components (8) - Air changes per hour
infiltration = (open_chimneys + open_flues + closed_fire + solid_fuel + 
                other_heater + blocked + fans + vents + flueless)

infiltration_rate = infiltration / DV

# Pressurization test check
has_test = True
ap50 = 15  # Input - assumed

if has_test:
    if ap50 > 0:
        adjusted_infiltration = (ap50 / 20) + infiltration_rate
    else:
        adjusted_infiltration = (0.263 * (ap4 ** 0.924)) + infiltration_rate
else:
    # Manual infiltration calculation
    storeys = 2  # Input
    additional = (storeys - 1) * 0.1 if storeys > 1 else 0
    
    construction = 'masonry'  # Input
    structural = 0.25 if construction in ['steel', 'timber'] else 0.35
    
    floor = 'none'  # Input
    floor_infiltration = 0.2 if floor == 'unsealed' else 0.1 if floor == 'sealed' else 0
    
    lobby = 0  # Input
    lobby_infiltration = 0.05 if lobby == 0 else 0
    
    proofing = 50  # Input
    window_infiltration = 0.25 - (0.2 * proofing / 100)
    
    adjusted_infiltration = (infiltration_rate + additional + structural + 
                            floor_infiltration + lobby_infiltration + window_infiltration)

# Shelter factor
sheltered_sides = 2  # Input
shelter_factor = 1 - (0.075 * sheltered_sides)

final_infiltration = adjusted_infiltration * shelter_factor


# Monthly wind factor (22-22b)
monthly_wind = [5.10,5.00, 4.90,4.40, 4.30,3.80,3.80,3.70,4.00,4.30,4.50,4.70]
wind_factors = [w/4 for w in monthly_wind]
adjusted_monthly = [final_infiltration * wf for wf in wind_factors]

# Mechanical ventilation
system = 'natural'

effective_ach = []
for monthly in adjusted_monthly:
    if system == 'mvhr':
        efficiency = 80
        ach = monthly + 0.5 * (1 - efficiency/100)
    elif system == 'balanced':
        ach = monthly + 0.5
    elif system == 'mechanical':
        ach = monthly + 0.5 if monthly < 0.25 else monthly + 0.25
    else:  # natural
        ach = monthly if monthly >= 1 else 0.5 + (0.5 * monthly**2)
    effective_ach.append(ach)

# Results
print(f"Box 8 Initial infiltration rate: {infiltration_rate:.2f} ACH")
print(f"Box 18 Adjusted infiltration: {adjusted_infiltration:.2f} ACH")
print(f"Box 21 With shelter factor: {final_infiltration:.2f} ACH")
print(f"Box 25 Effective ach: {[round(x, 2) for x in effective_ach]} ACH")

```

    Box 8 Initial infiltration rate: 0.05 ACH
    Box 18 Adjusted infiltration: 0.80 ACH
    Box 21 With shelter factor: 0.68 ACH
    Box 25 Effective ach: [0.88, 0.86, 0.85, 0.78, 0.77, 0.71, 0.71, 0.7, 0.73, 0.77, 0.79, 0.82] ACH


# 3. Heat lossses and heat loss parameter


```python
solid_door_area = 2.00
solid_door_u_value = 1.00
doors_2 = 2 * 0.5
# windows use updated U value formula
u_value_windows = 1/((1/1.4)+0.04)
window_area =15
windows =  window_area * u_value_windows
ground_floor = 52 * 0.15
walls = (150 -20.65)*0.17
roof = 52 * 0.11

total_area_of_external_elements = solid_door_area + window_area + 52 + (150-20.65) +52 + 1.85

# TODO party wall, internal wall, internal ceiling
party_wall_heat_loss = 0

solid_door_heat_loss = solid_door_area * solid_door_u_value

fabric_heat_loss = solid_door_heat_loss + doors_2 +windows + ground_floor + walls +roof +party_wall_heat_loss
# TODO heat capacity - wall + party + internal 
heat_capacity =  party_wall_heat_loss

# user defined TMP
TMP = 250 # Input

linear_thermal_bridges = 0
point_thermal_bridges = 0
# default
thermal_bridges = 0.15 * total_area_of_external_elements


total_fabric_heat_loss = fabric_heat_loss + thermal_bridges

ventilation_heat_loss = [0.33 * ach * DV for ach in effective_ach]


HTC = [vent + total_fabric_heat_loss for vent in ventilation_heat_loss ]
HTC_avg = sum(HTC) / len(HTC)

HLP = [HT / TFA for HT in HTC ]

# Box 41
days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]

print(f"Box 31 Total area of external elements {total_area_of_external_elements:.2f}")
print(f"Box 33 Fabric heat loss {fabric_heat_loss:.2f}")
print(f"Box 37 Total fabric heat loss {total_fabric_heat_loss:.2f}")
print(f"Box 38 Ventilation heat loss {[round(x, 2) for x in ventilation_heat_loss]}")
print(f"Box 39 HTC {[round(x, 2) for x in HTC]}")
print(f"Box 40 HLP {[round(x, 2) for x in HLP]}")



```

    Box 31 Total area of external elements 252.20
    Box 33 Fabric heat loss 58.40
    Box 37 Total fabric heat loss 96.23
    Box 38 Ventilation heat loss [55.07, 54.15, 53.25, 49.01, 48.21, 44.52, 44.52, 43.84, 45.94, 48.21, 49.82, 51.5]
    Box 39 HTC [151.3, 150.38, 149.47, 145.23, 144.44, 140.74, 140.74, 140.06, 142.17, 144.44, 146.04, 147.72]
    Box 40 HLP [1.99, 1.98, 1.97, 1.91, 1.9, 1.85, 1.85, 1.84, 1.87, 1.9, 1.92, 1.94]


# 4. Water heating requirement 


```python

Tcold_m = [5, 5, 6, 8, 10, 12, 14, 14, 12, 10, 8, 6]  # From Table J1

N = 1 + 1.76*(1-math.exp(-0.000349*(TFA-13.9)**2)) + 0.0013*(TFA-13.9) if TFA > 13.9 else 1

Vd = (25 * N) + 36
Monthly_factors = [1.10, 1.06, 1.02, 0.98, 0.94, 0.90, 0.90, 0.94, 0.98, 1.02, 1.06, 1.10]
#Hot water usage in litres per day for each month Vd,m = factor from Table 1c Â¥ (43)
Vd_mon = [fac*Vd for fac in Monthly_factors]

# Table 1d: Temperature rise of hot water drawn off (DTm, in K)
delta_t = [41.2, 41.4, 40.1, 37.6, 36.4, 33.9, 30.4, 33.4, 33.5, 36.3, 39.4, 39.9]

# 3. Energy content (45)
energy_content =[]
i = 0
for Vd in Vd_mon:
    energy_content.append(4.18 * Vd * days_in_month[i]*delta_t[i] / 3600 )
    i+=1

# 4. Loss calculations
distribution_loss = [0.15*energy for energy in energy_content]

is_heat_network = False
has_storage = True

# Storage loss (56)
storage_loss = [0]*12
if has_storage:
    storage_loss = 1.23
    # water heating separtely timed and has a cylinderstat
    temp_factor = 0.54            # Table 2b
    storage_loss_daily = storage_loss * temp_factor
    storage_loss = [storage_loss_daily*day for day in days_in_month]


# Primary circuit loss applies when hot water is heated by a heat generator (e.g. boiler) connected to a hot
# water storage vessel via insulated or uninsulated pipes (the primary pipework).
# Table 3: Primary circuit loss
# Cylinder thermostat, water heating separately timed  
h = [3]*12
# Insulated
p = 1
i = 0
primary_loss = []
for day in days_in_month:
    primary_loss.append(day * 14 * ((0.0091 * p + 0.0245 * (1 - p)) * h[i] + 0.0263))
    i+=1

# 5. Total heat requirement (62)
new_energy_content = [0.85 * energy for energy in energy_content]
total_heat = [sum(heat) for heat in zip(new_energy_content, distribution_loss, storage_loss, primary_loss)]

# 6. Renewables
wwhrs = [0]*12  # Negative kWh
solar = [0]*12
output_water_heater = [sum(heat) for heat in zip(total_heat, wwhrs, solar)]

# 7. Heat gains
electric_shower = [0]*12 
combi_loss  = [0]*12
def heat_gains(energy_content, combi_loss, electric_shower, distribution_loss, primary_loss, storage_loss, has_storage):
    print(energy_content, combi_loss, electric_shower, distribution_loss, primary_loss, storage_loss)
    return [
        0.25 * (0.85*e + c + es) + 0.8 * (d + p + (s if has_storage else 0))
        for e, c, es, d, p, s in zip(energy_content, combi_loss, electric_shower, distribution_loss, primary_loss, storage_loss)
    ]
total_heat_gains_water = heat_gains(energy_content, combi_loss, electric_shower, distribution_loss, primary_loss, storage_loss, has_storage)



# Results
print(f"Box 42 Occupancy {N:.2f}")
print(f"Box 44 Average daily hot water use {[round(x, 2) for x in Vd_mon]}")
print(f"Box 45 Energy content {[round(x, 2) for x in energy_content]}")
print(f"Box 46 Distribution loss {[round(x, 2) for x in distribution_loss]}")
print(f"Box 55 Standing loss {storage_loss_daily:.2f}")
print(f"Box 65 Heat gains {[round(x, 2) for x in total_heat_gains_water]}")


```

    [155.89160561947273, 136.3437933748102, 140.6945819295603, 122.66094618625252, 117.696098364428, 101.56278408984379, 94.11284928836656, 107.99587047724988, 109.28568343721966, 127.36192828037501, 139.02550359646793, 150.97269573342135] [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] [23.383740842920908, 20.45156900622153, 21.10418728943404, 18.399141927937876, 17.6544147546642, 15.234417613476568, 14.116927393254985, 16.199380571587483, 16.39285251558295, 19.10428924205625, 20.85382553947019, 22.6459043600132] [23.2624, 21.011200000000002, 23.2624, 22.512, 23.2624, 22.512, 23.2624, 23.2624, 22.512, 23.2624, 22.512, 23.2624] [20.5902, 18.5976, 20.5902, 19.926000000000002, 20.5902, 19.926000000000002, 20.5902, 20.5902, 19.926000000000002, 20.5902, 19.926000000000002, 20.5902]
    Box 42 Occupancy 2.38
    Box 44 Average daily hot water use [105.12, 101.3, 97.48, 93.65, 89.83, 86.01, 86.01, 89.83, 93.65, 97.48, 101.3, 105.12]
    Box 45 Energy content [155.89, 136.34, 140.69, 122.66, 117.7, 101.56, 94.11, 108.0, 109.29, 127.36, 139.03, 150.97]
    Box 46 Distribution loss [23.38, 20.45, 21.1, 18.4, 17.65, 15.23, 14.12, 16.2, 16.39, 19.1, 20.85, 22.65]
    Box 55 Standing loss 0.66
    Box 65 Heat gains [86.92, 77.02, 81.86, 74.74, 74.22, 67.72, 66.37, 70.99, 70.29, 77.43, 80.18, 85.28]


# 5. Internal gains


```python
## Appliances L10
EA_initial = 207.8 * (TFA * N)**0.4714

# Monthly calculations
monthly_energy = []
monthly_heat_gain_appliances = []

for m in range(1, 13):  # January=1 to December=12
    # Monthly energy (L11)
    EA_m = EA_initial * (1 + 0.157 * math.cos(2 * math.pi * (m - 1.78) / 12)) 
    EA_m *= days_in_month[m-1] / 365
    monthly_energy.append(EA_m)
    
    # Heat gain in watts (L13)
    GA_m = EA_m * 1000 / (24 * days_in_month[m-1])
    monthly_heat_gain_appliances.append(GA_m)

# Recalculated annual energy (L12)
EA_recalculated = sum(monthly_energy)





```


```python
# Lighting gains
LLE = 16    # low-energy outlets
L = 16     # total fixed outlets
# GL from Table 6b
window_data = [
    {'Aw': window_area, 'gL': 0.8, 'ZL': 0.9, 'FF': 0.7}
]

# L1: Base energy consumption
EB = 59.73 * (TFA * N)**0.4714

# L2: Low-energy correction factor
C1 = 1 - 0.50 * LLE/L if L > 0 else 1.0

# L5: Calculate GL
sum_components = sum(
    window['Aw'] * window['gL'] * window['ZL'] * window.get('FF', 0.7)
    for window in window_data
)
GL = (0.9 * sum_components) / TFA

# L3/L4: Daylight correction factor
C2 = (52.2 * GL**2 - 9.94 * GL + 1.433) if GL <= 0.095 else 0.96

# L6: Initial annual energy
EL_initial = EB * C1 * C2

# Monthly calculations
monthly_energy = []
monthly_heat_gain_lighting = []

for m in range(1, 13):  # January=1 to December=12
    # L7: Monthly energy
    EL_m = EL_initial * (1 + 0.5 * math.cos(2 * math.pi * (m - 0.2) / 12))
    EL_m *= days_in_month[m-1] / 365
    monthly_energy.append(EL_m)
    
    # Heat gain with 0.85 factor (L8 equivalent)
    GL_m = EL_m * 0.85 * 1000 / (24 * days_in_month[m-1])
    monthly_heat_gain_lighting.append(GL_m)

# L8: Recalculated annual energy
EL_recalculated = sum(monthly_energy)

print(monthly_heat_gain_lighting)
```

    [47.0727891814745, 41.809634137870766, 34.00188056717905, 25.741609733367426, 19.242154535618052, 16.24503874541016, 17.553337118352506, 22.816492161956237, 30.624245732647953, 38.88451656645959, 45.38397176420895, 48.38108755441685]



```python
metabolic_gains = [60 * N]*12
lighting_gains = monthly_heat_gain_lighting
appliance_gains = monthly_heat_gain_appliances
cooking_gains = [35 + 7 * N ] *12
pumps_fans_gains = [3]*12
evap_losses = [-40 * N]*12
water_heating_gains =[]
for i in range(len(total_heat_gains_water)):
    water_heating_gain = 1000 * total_heat_gains_water[i] / (days_in_month[i]*24)
    water_heating_gains.append(water_heating_gain)

total_internal_gains = [sum(x) for x in zip(metabolic_gains, lighting_gains, appliance_gains ,cooking_gains , pumps_fans_gains , evap_losses , water_heating_gains)]

print(f"Box 66 {[round(x) for x in metabolic_gains]}")
print(f"Box 67 {[round(x) for x in lighting_gains]}")
print(f"Box 68 {[round(x) for x in appliance_gains]}")
print(f"Box 69 {[round(x) for x in cooking_gains]}")
print(f"Box 70 {[round(x) for x in pumps_fans_gains]}")
print(f"Box 71 {[round(x) for x in evap_losses]}")
print(f"Box 72 {[round(x) for x in water_heating_gains]}")
print(f"Box 73 Total internal gains {[round(x) for x in total_internal_gains]}")


```

    Box 66 [143, 143, 143, 143, 143, 143, 143, 143, 143, 143, 143, 143]
    Box 67 [47, 42, 34, 26, 19, 16, 18, 23, 31, 39, 45, 48]
    Box 68 [315, 318, 310, 292, 270, 249, 235, 232, 240, 258, 280, 301]
    Box 69 [52, 52, 52, 52, 52, 52, 52, 52, 52, 52, 52, 52]
    Box 70 [3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3]
    Box 71 [-95, -95, -95, -95, -95, -95, -95, -95, -95, -95, -95, -95]
    Box 72 [117, 115, 110, 104, 100, 94, 89, 95, 98, 104, 111, 115]
    Box 73 Total internal gains [581, 577, 556, 524, 491, 462, 445, 453, 471, 503, 539, 566]


# 6. Solar gains


```python

# SAP 2012 Tables U3 and U4 data for UK Average
uk_avg_horizontal = [26, 54, 96, 150, 192, 200, 189, 157, 115, 66, 33, 21]  # W/mÂ²
solar_declination = [-20.7, -12.8, -1.8, 9.8, 18.8, 23.1, 21.2, 13.7, 2.9, -8.7, -18.4, -23.0]  # degrees
uk_latitude = 53.5  # degrees

# East/West constants from Table U5
k1, k2, k3 = 1.44, -2.36, 1.07
k4, k5, k6 = -0.514, 1.89, -1.64
k7, k8, k9 = -0.542, -0.757, 0.604

def calculate_monthly_flux():
    monthly_flux = []
    
    for month in range(12):
        # Calculate A, B, C coefficients
        pitch = 90  # Vertical window
        p_rad = math.radians(pitch)
        sin_term = math.sin(p_rad/2)
        
        A = k1 * sin_term**3 + k2 * sin_term**2 + k3 * sin_term
        B = k4 * sin_term**3 + k5 * sin_term**2 + k6 * sin_term
        C = k7 * sin_term**3 + k8 * sin_term**2 + k9 * sin_term + 1
        
        # Calculate Rh-inc factor
        lat_minus_decl = math.radians(uk_latitude - solar_declination[month])
        cos_term = math.cos(lat_minus_decl)
        rh_inc = A * cos_term**2 + B * cos_term + C
        
        # Calculate final solar flux
        sh = uk_avg_horizontal[month]
        s_orient = sh * rh_inc
        monthly_flux.append(round(s_orient, 2))
    
    return monthly_flux

# Get annual monthly fluxes
monthly_solar_flux = calculate_monthly_flux()


```


```python
access_factors = 0.9
window_area = 15
g = 0.63
# frame factor
ff = 0.7
shading = 0.77

# Assumed 1 window
east_west = [access_factors * window_area * flux * g * ff *shading for flux in monthly_solar_flux]
solar_gains = east_west


total_gains = [ gain+solar for gain,solar in zip(total_internal_gains,solar_gains)]

print(f"Box 82 {[round(x) for x in solar_gains]}")
print(f"Box 84 {[round(x) for x in total_gains]}")

```

    Box 82 [90, 176, 290, 423, 518, 531, 505, 434, 337, 209, 112, 74]
    Box 84 [671, 753, 846, 947, 1010, 993, 950, 887, 808, 712, 651, 640]


# 7. Mean internal temperature


```python
def calculate_utilisation_factor(H, G, Ti, Te):

    # Calculate alpha
    a = 1 + time_constant / 15
    
    # Calculate heat loss rate L (W)
    L = H * (Ti - Te)
    
    # Handle special case when L = 0
    if L == 0:
        Î³ = 1e6  # Large number to represent infinity
    else:
        Î³ = G / L
    
    # Round Î³ to 8 decimal places to avoid instability
    Î³ = round(Î³, 8)
    
    # Calculate utilisation factor based on Î³ value
    if Î³ <= 0:
        Î· = 1.0
    elif Î³ == 1:
        Î· = a / (a + 1)
    else:
        numerator = 1 - Î³**a
        denominator = 1 - Î³**(a + 1)
        Î· = numerator / denominator
    
    return Î·


def temperature_reduction(Ï„, toff, Th, Tsc):
    """Table 9b: Temperature reduction calculation"""
    tc = 4 + 0.25 * Ï„
    
    if toff <= tc:
        u = 0.5 * toff**2 * (Th - Tsc) / (24 * tc)
    else:
        u = (Th - Tsc) * (toff - 0.5 * tc) / 24
    
    return u



# MIT Living area

# External temperature
Te = [4.3, 4.9,	6.5	,    8.9	,  11.7	 , 14.6	 , 16.6	,  16.4	,  14.1	 , 10.6	,    7.1	,    4.2]
Q_heat_all =[]
final_MIT_all = []
utilisation_factor_final_all = []
for i in range(len(HLP)):
    # Calculate time constant Ï„ (hours)
    time_constant = TMP / (3.6 * HLP[i])

    # Living area 
    """
    Living area
    1. Set Ti
    to the temperature for the living area during heating periods (Table 9)
    2. Calculate the utilisation factor (Table 9a)
    3 Calculate the temperature reduction (Table 9b) for each off period (Table 9), u1 and u2, for weekdays
    4. Tweekday = Th â€“ (u1 + u2)
    5 Calculate the temperature reduction (Table 9b) for each off period (Table 9), u1 and u2, for weekends
    6. Tweekend = Th â€“ (u1 + u2)
    7. Mean temperature (living area) T1 = ( 5 Tweekday + 2 Tweekend) / 7
    """
    Th1 = 21 
    utilisation_factor_LA = calculate_utilisation_factor(HTC[i], total_gains[i], Th1, Te[i])

    Responsiveness = 1
    Tsc_living = (1 - Responsiveness) * (Th1 - 2.0) + Responsiveness * (Te[i] + utilisation_factor_LA * total_gains[i] / HTC[i])
    toff1=7
    toff2=8
    u1 = temperature_reduction(time_constant, toff1, Th1, Tsc_living)
    u2 = temperature_reduction(time_constant, toff2, Th1, Tsc_living)

    T1_weekday = Th1 - (u1 + u2)

    toff1=8
    toff2=0
    u1 = temperature_reduction(time_constant, toff1, Th1, Tsc_living)
    u2 = temperature_reduction(time_constant, toff2, Th1, Tsc_living)

    T1_weekend = Th1 - (u1 + u2)

    T1_LA= (5*T1_weekday+2*T1_weekend)/7


    # MIT Rest of house
    """
    8. Set Ti to the temperature for elsewhere during heating periods (Table 9)
    9. Repeat steps 2 to 7 above to obtain the mean temperature (rest of dwelling), T2
    """
    # assumed control type 2 - programmer, room thermostat and TRVs
    Th2 = 21-HLP[i]+(HLP[i]**2/12)



    utilisation_factor_ROH = calculate_utilisation_factor(HTC[i], total_gains[i], Th2, Te[i])
    Responsiveness = 1
    Tsc_living = (1 - Responsiveness) * (Th2 - 2.0) + Responsiveness * (Te[i] + utilisation_factor_ROH * total_gains[i] / HTC[i])
    toff1=7
    toff2=8
    u1 = temperature_reduction(time_constant, toff1, Th2, Tsc_living)
    u2 = temperature_reduction(time_constant, toff2, Th2, Tsc_living)

    T1_weekday = Th2 - (u1 + u2)

    toff1=8
    toff2=0
    u1 = temperature_reduction(time_constant, toff1, Th2, Tsc_living)
    u2 = temperature_reduction(time_constant, toff2, Th2, Tsc_living)

    T1_weekend = Th2 - (u1 + u2)

    T2_ROH= (5*T1_weekday+2*T1_weekend)/7


    # Whole dwelling
    LA_area = 18
    LA_area_frac = LA_area / TFA

    MIT = LA_area_frac * T1_LA + (1-LA_area_frac) * T2_ROH


    # Temperature adjustment - if no controls this will be higher
    # Assumed programmer, room thermostat and TRVs
    adjustment = 0
    final_MIT = MIT - adjustment
    final_MIT_all.append(final_MIT)

    # Recalculate utilisation factor
    Î·_final = calculate_utilisation_factor(HTC[i], total_gains[i], MIT, Te[i])
    
    # Heat requirement calculation
    L = HTC[i] * (MIT - Te[i])
    # Space_heating_req = 0.024 * (heat_loss_MIT - useful_gains) * number_days
    Q_heat = 0.024 * (L - Î·_final * total_gains[i])*days_in_month[i]
    
    # Apply non-negative floor
    Q_heat = max(Q_heat, 0) if Q_heat >= 1 else 0

    Q_heat_all.append(Q_heat)

    utilisation_factor_final = calculate_utilisation_factor(HTC[i], total_gains[i], final_MIT, Te[i])
    utilisation_factor_final_all.append(utilisation_factor_final)



print(f"Box 93 final MIT {[round(x,2) for x in final_MIT_all]}")


```

    Box 93 final MIT [17.94, 18.14, 18.49, 19.01, 19.42, 19.7, 19.78, 19.78, 19.59, 19.07, 18.46, 17.96]


# 8. Space heating requirement


```python
# Table 9a
useful_gains = [ util*gain for util,gain in zip(utilisation_factor_final_all,total_gains)]


#heat_loss_MIT = HTC * (adjusted_MIT-external_temp)
heat_loss_MIT_all = []
for i in range(len(HTC)):
    heat_loss_MIT = HTC[i] * (final_MIT_all[i]- Te[i])
    heat_loss_MIT_all.append(heat_loss_MIT)



months_remov = [1,1,1,1,1,0,0,0,0,1,1,1]
space_heat_final = [mon*space_each for mon,space_each in zip(months_remov, Q_heat_all)]
space_heat = sum(space_heat_final)
space_heat_req_m2 = space_heat / TFA

print(f"Box 98 Heat released {[round(x) for x in space_heat_final]}")


```

    Box 98 Heat released [1044, 844, 732, 438, 220, 0, 0, 0, 0, 418, 737, 1043]


# 9. Energy requirements <br>
- Space heating


```python
main2_frac = 0
secondary_frac = 0
main_total_frac = 1 - secondary_frac
main1_frac = main_total_frac * (1 - main2_frac)
main2_frac = main_total_frac * main2_frac


# Adjustments from table D2.7 row D1.5
nSAP = 87
nwinter = nSAP + 1
nsummer = nSAP -9.7

eff_main1_space_system = nwinter / 100
eff_main2_space_system = 0.9
eff_second_main_system = 0.8

space_heating_fuel_main1 = [ req * main1_frac /eff_main1_space_system for req in space_heat_final] 
space_heating_fuel_main2 = [ req * main2_frac/eff_main2_space_system for req in space_heat_final] 
space_heating_fuel_secon = [ req * secondary_frac/eff_second_main_system for req in space_heat_final] 

print(f"Box 211 Space heating fuel main {[round(x) for x in space_heating_fuel_main1]}")


```

    Box 211 Space heating fuel main [1187, 959, 832, 498, 250, 0, 0, 0, 0, 475, 838, 1185]


- Water heating


```python
# From database then adjusted based on Table 4c -summer eff for boilers
# TODO calculate
# Sime Ecocomort System 25 HE

nwater = []
for i in range(len(output_water_heater)):
    nwater_mon = (space_heat_final[i] + output_water_heater[i] )/ ((space_heat_final[i]/nwinter) +(output_water_heater[i]/nsummer))
    nwater.append(nwater_mon)
print(nwater)
eff_water_heater = nwater

fuel_water_heating = [output*100/(eff) for eff, output in zip(eff_water_heater,output_water_heater)]
print(output_water_heater)
print(f"Box 219 Water heating fuel {[round(x) for x in fuel_water_heating]}")
```

    [86.08688677412908, 85.9478398483364, 85.61424097839465, 84.78716056140846, 83.12486818117317, 77.3, 77.3, 77.3, 77.3, 84.59659714317606, 85.65759856261097, 86.12305151366846]
    [199.74420561947272, 175.9525933748102, 184.54718192956028, 165.09894618625253, 161.548698364428, 144.0007840898438, 137.96544928836656, 151.8484704772499, 151.72368343721968, 171.21452828037502, 181.46350359646792, 194.82529573342134]
    Box 219 Water heating fuel [232, 205, 216, 195, 194, 186, 178, 196, 196, 202, 212, 226]


### Annual totals


```python
space_heating_fuel_main1_annual  = sum(space_heating_fuel_main1)
space_heating_fuel_main2_annual = sum(space_heating_fuel_main2)
space_heating_fuel_secon_annual = sum(space_heating_fuel_secon)
fuel_water_heating_annual = sum(fuel_water_heating)

#total_delievered_energy = space_heating_fuel_main1_annual + fuel_water_heating


print(f"Box 211 {space_heating_fuel_main1_annual}")
print(f"Box 215 {space_heating_fuel_main2_annual}")
print(f"Box 219 {fuel_water_heating_annual}")



```

    Box 211 6222.687266854421
    Box 215 0.0
    Box 219 2439.311853504036


- Electricty for pumps and fans and lighting


```python
# Natural ventilation so no mechanical ventilation
mech_vent = False
elec_mech_fans = 0
if mech_vent:
    IUF = 1.1
    SFP = 0.9
    elec_mech_fans = IUF * SFP * 1.22 * DV

#TODO find origin
elec_flue_fan = 45
elec_heating_circ = 30

elec_warm_air_fans = 0 
elec_oil_boiler_aux = 0
elec_keep_hot_gas_combi = 0
elec_pump_solar_water = 0
elec_storage_wwhr = 0

total_electricity_pumps = elec_mech_fans + elec_warm_air_fans + elec_heating_circ + elec_oil_boiler_aux +elec_keep_hot_gas_combi+elec_pump_solar_water + elec_storage_wwhr +elec_flue_fan
print(f"Box 231 Electricity pumps {total_electricity_pumps}")

```

    Box 231 Electricity pumps 75


- Lighting electricity


```python
# LEL fittings - low energy lighting e.g. LED or CFL
# TODO calculate
lighting = 422
print(f"Box 232 Electricity lighting {lighting}")
```

    Box 232 Electricity lighting 422


### Total delivered energy


```python

total_delivered_energy = space_heating_fuel_main1_annual + space_heating_fuel_main2_annual + fuel_water_heating_annual + total_electricity_pumps + lighting
print(f"Box 238 {total_delivered_energy}")
```

    Box 238 9158.999120358458


- Energy saving technologies - used in dwelling and energy exported


```python
electricity_gen_PV_dwelling = 0
electricity_gen_wind_turbines_dwelling = 0
electrcity_gen_hyrdo_electric_gen_dwelling = 0
electricity_gen_micro_CHP_dwelling = 0

electricity_gen_PV_export = 0
electricity_gen_wind_turbines_export = 0
electrcity_gen_hyrdo_electric_gen_export = 0
electricity_gen_micro_CHP_export = 0
```

# 10. Fuel costs - SAP rating


```python

# p/kWh
fuel_price_gas = 3.48
fuel_price_elec = 13.19

space_heating_cost_main1 = space_heating_fuel_main1_annual   * fuel_price_gas * 0.01
space_heating_cost_main2 = space_heating_fuel_main2_annual  * fuel_price_elec * 0.01
water_heating_cost = fuel_water_heating_annual  * fuel_price_gas * 0.01
total_electricity_pumps_cost =  total_electricity_pumps  * fuel_price_elec * 0.01
lighting_cost = lighting  * fuel_price_elec * 0.01
standing_charges = 120

total_energy_cost = standing_charges + space_heating_cost_main1 + space_heating_cost_main2 +water_heating_cost+total_electricity_pumps_cost + lighting_cost
print(space_heating_cost_main1, water_heating_cost, total_electricity_pumps_cost, lighting_cost)
print(total_energy_cost)

energy_cost_deflator = 0.42

# Cost deflator to normalize energy costs over time, ensuring SAP ratings remain  comparable across different fuel price.
def calc_sap_rating(deflator, tfa):
    # Calculate Energy Cost Factor (ECF)
    ecf = (deflator * total_energy_cost) / (tfa + 45)
    # Determine SAP rating based on ECF threshold
    if ecf >= 3.5:
        sap = 117 - 121 * math.log10(ecf)
    else:
        sap = 100 - 13.95 * ecf
    
    # Apply rounding and minimum value rules
    sap_rounded = round(sap)
    sap_final = max(1, sap_rounded) 
    return sap_final

sap_rating = calc_sap_rating(energy_cost_deflator, TFA)
print(sap_rating)

def get_rating_band(dwelling_rating):
    rating = [20,38,54,68,80,91]
    bands = ["G","F","E","D","C","B"]
    for i in range(len(bands)):
        if dwelling_rating<=rating[i]:
            band = bands[i]
            break
        elif dwelling_rating>=92:
            band = "A"
            break
    return band

sap_band = get_rating_band(sap_rating)
print(sap_band)

```

    216.54951688653387 84.88805250194046 9.8925 55.66179999999999
    486.9918693884743
    76
    C


# 11. Co2 emissions


```python
# kgCo2/kWh
emission_factor_gas = 0.216
emission_factor_elec = 0.519

space_heating_co2_main1_annual = space_heating_fuel_main1_annual * emission_factor_gas
space_heating_co2_main2_annual = space_heating_fuel_main2_annual * emission_factor_elec
water_heating_co2 = fuel_water_heating_annual * emission_factor_gas 
total_electricity_pumps_co2 =  total_electricity_pumps  * emission_factor_elec 
lighting_co2 = lighting * emission_factor_elec
print(space_heating_co2_main1_annual, space_heating_co2_main2_annual, water_heating_co2, total_electricity_pumps_co2, lighting_co2)

total_co2 = space_heating_co2_main1_annual + space_heating_co2_main2_annual + water_heating_co2 +total_electricity_pumps_co2 + lighting_co2


def calc_ei(co2_emissions, tfa):
    # Calculate Carbon Factor
    cf = co2_emissions / (tfa + 45)
    
    # Determine EI rating
    if cf >= 28.3:
        ei = 200 - 95 * math.log10(cf)
    else:
        ei = 100 - 1.34 * cf
    
    # SAP rounding and minimum rules
    ei_rounded = round(ei)
    ei_final = max(1, ei_rounded)
    return ei_final

ei = calc_ei(total_co2, TFA)
print(total_co2)
print(ei)

ei_band = get_rating_band(ei)
print(ei_band)
```

    1344.1004496405549 0.0 526.8913603568718 38.925000000000004 219.018
    2128.9348099974263
    76
    C

